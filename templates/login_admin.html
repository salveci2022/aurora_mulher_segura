<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ¬∑ Aurora</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    /* Estilos adicionais sem quebrar o design */
    .redundancy-card {
      margin-top: 20px;
      border: 1px solid rgba(255,98,212,.22);
      border-radius: 16px;
      overflow: hidden;
    }
    .redundancy-header {
      background: rgba(255,79,200,0.15);
      padding: 12px 15px;
      border-bottom: 1px solid rgba(255,98,212,.22);
    }
    .redundancy-body {
      padding: 15px;
    }
    .backend-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin: 5px 0;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      border-left: 3px solid transparent;
    }
    .backend-item.online {
      border-left-color: #00ff00;
    }
    .backend-item.offline {
      border-left-color: #ff0000;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    .stat-box {
      background: rgba(255,79,200,0.05);
      border-radius: 8px;
      padding: 10px;
      text-align: center;
    }
    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #ff4fc8;
    }
    .stat-label {
      font-size: 10px;
      color: #cdb7e6;
    }
    .refresh-btn {
      background: none;
      border: 1px solid rgba(255,98,212,.28);
      color: #ffd0f0;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 11px;
      cursor: pointer;
      margin-left: 10px;
    }
    .refresh-btn:hover {
      background: rgba(255,98,212,.1);
    }
  </style>
</head>
<body class="aurora-bg">
  <main class="center-wrap">
    <section class="aurora-card">
      <div class="topbar">
        <div class="brand">
          <div class="brand-dot">‚ôÄ</div>
          <div>
            <div class="brand-title">AURORA_MULHER_SEGURA</div>
            <div class="brand-sub">Painel Admin</div>
          </div>
        </div>
        <div class="top-actions">
          <a class="pill" href="/panic">Painel da mulher</a>
          <a class="pill" href="/logout_admin">Sair</a>
        </div>
      </div>

      <div class="content">
        <h1 class="h1">CADASTRO</h1>
        <p class="center muted small">Cadastre at√© 3 pessoas de confian√ßa.</p>

        {% if msg %}<div class="alert alert-ok">{{ msg.replace('+',' ') }}</div>{% endif %}
        {% if err %}<div class="alert alert-danger">{{ err.replace('+',' ') }}</div>{% endif %}

        <div class="list">
          {% for u, info in trusted.items() %}
          <div class="item">
            <div>
              <strong>{{ info.name }}</strong>
              <div class="badge">Usu√°rio: {{ u }}</div>
            </div>
            <form method="post" action="/panel/delete_trusted" onsubmit="return confirm('Remover esta pessoa?');">
              <input type="hidden" name="username" value="{{ u }}">
              <button class="pill" type="submit">Remover</button>
            </form>
          </div>
          {% endfor %}
          {% if trusted|length == 0 %}
            <div class="alert">Nenhuma pessoa cadastrada ainda.</div>
          {% endif %}
        </div>

        <form method="post" action="/panel/add_trusted" style="margin-top:14px">
          <label class="label">Nome</label>
          <input class="input" name="trusted_name" placeholder="Ex: M√£e da Ana" required>
          <label class="label">Usu√°rio (login)</label>
          <input class="input" name="trusted_user" placeholder="ex: maeana" required>
          <label class="label">Senha</label>
          <input class="input" name="trusted_password" placeholder="ex: 1234" required>
          <button class="btn btn-primary" type="submit">Cadastrar</button>
        </form>

        <!-- ===== CARD DE REDUND√ÇNCIA ===== -->
        <div class="redundancy-card">
          <div class="redundancy-header">
            <div style="display: flex; align-items: center; justify-content: space-between;">
              <h3 style="color: #ff4fc8; margin: 0; font-size: 16px;">üîÑ REDUND√ÇNCIA DE INFRAESTRUTURA</h3>
              <button class="refresh-btn" onclick="loadRedundancyStatus()">‚Üª Atualizar</button>
            </div>
            <p class="small muted" style="margin: 5px 0 0 0;">Failover autom√°tico entre servidores</p>
          </div>
          <div class="redundancy-body">
            <div id="redundancy-status">
              <div class="center">
                <span class="badge">Carregando status...</span>
              </div>
            </div>
          </div>
        </div>

        <div class="center small muted" style="margin-top:10px">
          Pessoa de confian√ßa entra em <span class="badge">/trusted/login</span>
        </div>
        <div class="center small muted" style="margin-top:5px">
          <a class="link" href="/api/redundancy-status" target="_blank">API Status</a> ¬∑ 
          <a class="link" href="/health" target="_blank">Health Check</a>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===== FUN√á√ÉO PARA CARREGAR STATUS DA REDUND√ÇNCIA =====
    async function loadRedundancyStatus() {
      const statusDiv = document.getElementById('redundancy-status');
      
      try {
        // Mostra loading
        statusDiv.innerHTML = `
          <div class="center">
            <span class="badge">üîÑ Atualizando...</span>
          </div>
        `;
        
        // Faz requisi√ß√£o para a API
        const response = await fetch('/api/redundancy-status');
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        console.log("üìä Status de redund√¢ncia:", data);
        
        let html = '';
        
        // Backend atual em destaque
        const currentBackend = data.backends.find(b => b.active) || data.backends[0];
        
        html += `
          <div style="margin: 10px 0 15px 0; padding: 12px; background: rgba(255,79,200,0.15); border-radius: 10px; text-align: center;">
            <div style="font-size: 12px; color: #cdb7e6; margin-bottom: 5px;">üîµ BACKEND ATIVO</div>
            <div style="font-size: 20px; font-weight: bold; color: #ff4fc8; letter-spacing: 1px;">${currentBackend.name.toUpperCase()}</div>
            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 8px;">
              <span class="badge">‚è±Ô∏è ${currentBackend.response_time || 'N/A'}</span>
              <span class="badge">üîÑ ${data.stats.total_switches} trocas</span>
            </div>
          </div>
        `;
        
        // Lista de backends
        html += `<div style="margin-bottom: 15px;">`;
        data.backends.forEach(b => {
          const statusClass = b.healthy ? 'online' : 'offline';
          const statusIcon = b.healthy ? '‚úÖ' : '‚ùå';
          const activeTag = b.active ? '<span style="background: #ff4fc8; color: #0a0014; padding: 2px 8px; border-radius: 12px; font-size: 10px; margin-left: 8px;">ATIVO</span>' : '';
          
          html += `
            <div class="backend-item ${statusClass}">
              <div>
                <strong style="font-size: 14px;">${b.name.toUpperCase()}</strong>
                ${activeTag}
              </div>
              <div style="display: flex; gap: 8px; align-items: center;">
                <span class="badge">${statusIcon} ${b.healthy ? 'Online' : 'Offline'}</span>
                <span class="badge">‚ö†Ô∏è ${b.failures} falhas</span>
                <span class="badge">üì° ${b.response_time || 'N/A'}</span>
              </div>
            </div>
          `;
        });
        html += `</div>`;
        
        // Estat√≠sticas adicionais
        html += `
          <div class="stats-grid">
            <div class="stat-box">
              <div class="stat-value">${data.stats.total_switches || 0}</div>
              <div class="stat-label">Trocas de servidor</div>
            </div>
            <div class="stat-box">
              <div class="stat-value">${data.stats.total_requests || 0}</div>
              <div class="stat-label">Requisi√ß√µes</div>
            </div>
            <div class="stat-box">
              <div class="stat-value">${data.stats.failed_requests || 0}</div>
              <div class="stat-label">Falhas</div>
            </div>
          </div>
        `;
        
        // √öltima troca
        if (data.stats.last_switch) {
          const lastSwitch = new Date(data.stats.last_switch).toLocaleString('pt-BR');
          html += `
            <div style="margin-top: 10px; text-align: center; font-size: 10px; color: #cdb7e6;">
              √öltima troca: ${lastSwitch}
            </div>
          `;
        }
        
        statusDiv.innerHTML = html;
        
      } catch (error) {
        console.error("‚ùå Erro ao carregar status:", error);
        statusDiv.innerHTML = `
          <div class="alert alert-danger" style="margin: 0;">
            <strong>‚ùå Erro ao carregar status</strong><br>
            <span class="small">${error.message}</span>
          </div>
        `;
      }
    }

    // Carregar status ao abrir a p√°gina
    document.addEventListener('DOMContentLoaded', () => {
      loadRedundancyStatus();
      // Atualizar a cada 10 segundos
      setInterval(loadRedundancyStatus, 10000);
    });

    // Mostrar notifica√ß√£o de failover (opcional)
    let lastActiveBackend = null;
    
    async function checkBackendChange() {
      try {
        const response = await fetch('/api/redundancy-status');
        const data = await response.json();
        const currentActive = data.backends.find(b => b.active)?.name;
        
        if (lastActiveBackend && lastActiveBackend !== currentActive) {
          // Mostrar notifica√ß√£o de failover
          const notification = document.createElement('div');
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff4fc8;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 0 20px rgba(255,79,200,0.5);
          `;
          notification.innerHTML = `
            üîÑ FAILOVER ATIVADO<br>
            <span style="font-size: 12px;">Servidor: ${currentActive?.toUpperCase()}</span>
          `;
          document.body.appendChild(notification);
          
          setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
          }, 4000);
        }
        
        lastActiveBackend = currentActive;
      } catch (e) {
        // Ignora erros
      }
    }
    
    // Verificar mudan√ßas a cada 5 segundos
    setInterval(checkBackendChange, 5000);
  </script>
</body>
</html>