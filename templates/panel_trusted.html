<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confian√ßa ¬∑ Painel</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    /* Estilos adicionais para o mapa - sem alterar o design original */
    .map-container {
      width: 100%;
      height: 200px;
      border-radius: 14px;
      margin-top: 10px;
      overflow: hidden;
      border: 1px solid rgba(255,98,212,.22);
      background: rgba(18,0,30,.45);
    }
    #map {
      width: 100%;
      height: 100%;
    }
    .location-details {
      margin-top: 8px;
      padding: 8px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      font-size: 11px;
    }
    .location-details .coord {
      font-family: monospace;
      color: #ffd0f0;
    }
    .accuracy-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(255,79,200,.2);
      color: #fff;
      font-size: 10px;
    }
  </style>
</head>
<body class="aurora-bg">
  <main class="center-wrap">
    <section class="aurora-card">
      <div class="topbar">
        <div class="brand">
          <div class="brand-dot">‚ôÄ</div>
          <div>
            <div class="brand-title">AURORA_MULHER_SEGURA</div>
            <div class="brand-sub">Painel da Pessoa de Confian√ßa</div>
          </div>
        </div>
        <div class="top-actions">
          <a class="pill" href="/trusted/change_password">Senha</a>
          <a class="pill" href="/logout_trusted">Sair</a>
        </div>
      </div>

      <div class="content">
        <h1 class="h1">CENTRAL SOS</h1>
        <p class="center muted small">Ol√°, <strong>{{ display_name }}</strong>. Quando chegar alerta novo, a sirene toca.</p>

        <div class="alert" id="alertBox">
          <div><strong>√öltimo alerta:</strong></div>
          <div class="small muted" id="lastMeta">Nenhum alerta ainda.</div>
          <div id="mapContainer" style="display: none;">
            <div class="map-container" id="map"></div>
            <div class="location-details" id="locationDetails"></div>
          </div>
          <div class="small" id="pretty"></div>
        </div>

        <div class="top-actions" style="justify-content:center; margin-top:12px">
          <button class="pill" id="armBtn" type="button">Ativar som</button>
          <button class="pill" id="muteBtn" type="button">Silenciar</button>
          <button class="pill" id="refreshBtn" type="button">Atualizar</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Leaflet CSS e JS para mapas -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const siren = new Audio('/static/audio/sirene.mp3');
  siren.loop = true;

  let armed = false;
  let muted = false;
  let lastId = 0;
  let map = null;
  let currentMarker = null;

  const armBtn = document.getElementById('armBtn');
  const muteBtn = document.getElementById('muteBtn');
  const refreshBtn = document.getElementById('refreshBtn');
  const lastMeta = document.getElementById('lastMeta');
  const pretty = document.getElementById('pretty');
  const mapContainer = document.getElementById('mapContainer');
  const locationDetails = document.getElementById('locationDetails');

  function escapeHtml(s){
    return (s||"").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  armBtn.addEventListener('click', async () => {
    try {
      siren.currentTime = 0;
      await siren.play();
      siren.pause();
      siren.currentTime = 0;
      armed = true;
      armBtn.textContent = 'Som ativado ‚úÖ';
    } catch (e) {
      armBtn.textContent = 'Clique novamente';
    }
  });

  muteBtn.addEventListener('click', () => {
    muted = !muted;
    if (muted) { 
      try { 
        siren.pause(); 
        siren.currentTime = 0; 
      } catch(e){} 
    }
    muteBtn.textContent = muted ? 'Ativar alarme' : 'Silenciar';
  });

  function playSiren(){
    if (!armed || muted) return;
    try {
      siren.currentTime = 0;
      siren.play().catch(()=>{});
      setTimeout(() => { 
        try { 
          siren.pause(); 
          siren.currentTime = 0; 
        } catch(e){} 
      }, 10000);
    } catch(e){}
  }

  function initMap(lat, lon, accuracy) {
    if (!map) {
      map = L.map('map').setView([lat, lon], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
      }).addTo(map);
    } else {
      map.setView([lat, lon], 15);
    }

    if (currentMarker) {
      map.removeLayer(currentMarker);
    }

    currentMarker = L.marker([lat, lon]).addTo(map);
    
    // Adicionar c√≠rculo de precis√£o
    if (accuracy) {
      L.circle([lat, lon], {
        radius: accuracy,
        color: '#ff4fc8',
        fillColor: '#ff4fc8',
        fillOpacity: 0.15
      }).addTo(map);
    }

    // For√ßar redimensionamento do mapa
    setTimeout(() => {
      map.invalidateSize();
    }, 100);
  }

  function renderAlert(a){
    if (!a){
      lastMeta.textContent = "Nenhum alerta ainda.";
      pretty.textContent = "";
      mapContainer.style.display = 'none';
      return;
    }
    
    lastMeta.textContent = `ID #${a.id} ¬∑ ${a.ts}`;

    const name = a.name || "N√£o informado";
    const situation = a.situation || "N√£o especificado";
    const message = a.message || "";
    const loc = a.location;

    let locationHtml = '';
    let mapHtml = '';
    
    if (loc && typeof loc.lat === "number" && typeof loc.lon === "number") {
      const lat = loc.lat.toFixed(6);
      const lon = loc.lon.toFixed(6);
      const acc = loc.accuracy_m ? Math.round(loc.accuracy_m) + "m" : "Precis√£o n√£o informada";
      const accClass = loc.accuracy_m && loc.accuracy_m < 20 ? 'accuracy-good' : 'accuracy-poor';
      const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
      const wazeUrl = `https://waze.com/ul?ll=${lat},${lon}&navigate=yes`;
      
      locationHtml = `
        <div style="margin-top:12px; border-top:1px solid rgba(255,98,212,.22); padding-top:8px;">
          <div class="badge">üìç Coordenadas: <span class="coord">${lat}, ${lon}</span></div>
          <div class="accuracy-badge" style="margin: 4px 0;">üéØ Precis√£o: ${acc}</div>
          <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
            <a class="pill" href="${mapsUrl}" target="_blank" rel="noopener" style="flex:1; text-align:center;">üó∫Ô∏è Google Maps</a>
            <a class="pill" href="${wazeUrl}" target="_blank" rel="noopener" style="flex:1; text-align:center;">üìç Waze</a>
          </div>
        </div>
      `;
      
      // Inicializar mapa
      setTimeout(() => {
        initMap(loc.lat, loc.lon, loc.accuracy_m);
        mapContainer.style.display = 'block';
      }, 100);
    } else {
      mapContainer.style.display = 'none';
    }

    pretty.innerHTML = `
      <div style="margin-top:10px">
        <div><strong>Nome:</strong> ${escapeHtml(name)}</div>
        <div><strong>Situa√ß√£o:</strong> ${escapeHtml(situation)}</div>
        ${message ? `<div><strong>Mensagem:</strong> ${escapeHtml(message)}</div>` : ""}
        ${locationHtml}
      </div>
    `;
  }

  async function tick(){
    try{
      const res = await fetch('/api/last_alert?ts=' + Date.now(), {cache:'no-store'});
      const data = await res.json();
      if(!data.ok) return;

      const a = data.last;
      renderAlert(a);

      if (a && a.id && a.id > lastId){
        lastId = a.id;
        playSiren();
      }
    } catch(e){
      console.error("Erro ao buscar alertas:", e);
    }
  }

  refreshBtn.addEventListener('click', tick);
  setInterval(tick, 2500);
  tick();
</script>
</body>
</html>